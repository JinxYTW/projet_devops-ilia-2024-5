name: Build and Push Tweet Service

on:
  push:
    branches: ["main"]
    paths:
      - 'tweet/**'
    # This ensures the workflow only runs after merges to main, not on PRs
    types: [closed]

env:
  PROJECT_ID: polytech-dijon
  REGION: europe-west1
  GAR_LOCATION: europe-west1-docker.pkg.dev/polytech-dijon/polytech-dijon/tweet_service
  WORKING_DIRECTORY: ./tweet

jobs:
  build-and-push:
    # Only run if the push is from a merged PR
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Run tests in Docker
        run: |
          cd ${{ env.WORKING_DIRECTORY }}
          docker build -t tweet-test -f Dockerfile.test .
          docker run --rm tweet-test

      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v1
        with:
          credentials_json: "${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}"

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Docker Auth
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build Image
        run: |
          cd ${{ env.WORKING_DIRECTORY }}
          docker build . --file Dockerfile --tag ${{ env.GAR_LOCATION }}

      - name: Push Image
        run: docker push ${{ env.GAR_LOCATION }} 